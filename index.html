<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YAI Study Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              gray: {
                750: '#2d3748',
                850: '#1a202c',
                950: '#020617',
              },
              brand: {
                50: '#f5f3ff',
                100: '#ede9fe',
                200: '#ddd6fe',
                300: '#c4b5fd',
                400: '#a78bfa',
                500: '#8b5cf6',
                600: '#7c3aed',
                700: '#6d28d9',
                800: '#5b21b6',
                900: '#4c1d95',
                950: '#2e1065',
              }
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'bounce-slight': 'bounce 1s infinite',
              'fadeIn': 'fadeIn 0.3s ease-out forwards',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          },
        },
      }
    </script>
    <style>
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #020617; }
      ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

      body {
        background-color: #020617;
        color: #f3f4f6;
      }
      .markdown-body p { margin-bottom: 0.75em; }
      .markdown-body ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 0.75em; }
      .markdown-body ol { list-style-type: decimal; margin-left: 1.5em; margin-bottom: 0.75em; }
      .markdown-body pre { background: #1e1b4b; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 0.75em; border: 1px solid #4338ca; }
      .markdown-body code { font-family: monospace; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(139, 92, 246, 0.5); }
    </style>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0",
        "react-markdown": "https://esm.sh/react-markdown@9.0.1?deps=react@18.2.0",
        "uuid": "https://esm.sh/uuid@9.0.1"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback } from 'react';
      import { createRoot } from 'react-dom/client';
      import {
        Bot, User, AlertCircle, Send, Loader2, Baby, ListOrdered,
        Image as ImageIcon, GraduationCap, BookOpen, PenTool,
        Sparkles, Check, RefreshCw, Trash2, Paperclip, X, BrainCircuit,
        Settings as SettingsIcon, Plus
      } from 'lucide-react';
      import ReactMarkdown from 'react-markdown';
      import { v4 as uuidv4 } from 'uuid';

      // ========= OPENROUTER CONFIG =========
      const API_KEY = "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"; // <--- put your key here
      const OPENROUTER_URL = "https://openrouter.ai/api/v1/chat/completions";
      const DEFAULT_MODEL = "mistralai/mistral-tiny";
      const STORAGE_KEY_CONV = "yai_conversations_v2";
      const STORAGE_KEY_THEME = "yai_theme_v1";

      const defaultTheme = {
        name: "Default",
        accent: "#8b5cf6",
        glow: "#4c1d95"
      };

      const isRateLimitError = (error) => {
        const msg = error?.message || '';
        const status = error?.status;
        return msg.includes('429') || status === 429 || msg.includes('Quota exceeded');
      };

      // Build OpenRouter messages with memory
      const buildMessagesWithHistory = (system, history, userText) => {
        const msgs = [];
        if (system) msgs.push({ role: "system", content: system });
        if (history && history.length) {
          const recent = history.slice(-12); // keep last 12 messages
          for (const m of recent) {
            if (!m.content) continue;
            if (m.role === 'user') {
              msgs.push({ role: 'user', content: m.content });
            } else if (m.role === 'model') {
              msgs.push({ role: 'assistant', content: m.content });
            }
          }
        }
        if (userText) msgs.push({ role: "user", content: userText });
        return msgs;
      };

      const callOpenRouter = async ({ system, user, model = DEFAULT_MODEL, history = [] }) => {
        const messages = buildMessagesWithHistory(system, history, user);
        const res = await fetch(OPENROUTER_URL, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + API_KEY,
            "Content-Type": "application/json",
            "HTTP-Referer": "http://localhost"
          },
          body: JSON.stringify({
            model,
            messages
          })
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error("OpenRouter error: " + text);
        }
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "";
      };

      // ========= SYSTEM INSTRUCTIONS =========
      const getSystemInstruction = (grade, style, mode = 'homework') => {
        if (mode === 'essay') {
          return `
You are "YAI", a friendly writing helper for a Grade ${grade} student.
You can help with school writing and personal topics, but always keep it safe and respectful.
Encourage learning and honesty. Do NOT help cheat on tests or big graded assignments.
Use Markdown formatting.`;
        }

        let base = `You are "YAI", a personalized AI helper for a Grade ${grade} student.
If asked "Who made you?", respond EXACTLY with: "**I was made by YAI's team.**"
When asked "what model are you", say "I am YAI, your personal study assistant."

You can talk about ANY safe topic: school, hobbies, games, questions about life, etc.
Always explain things in a way a Grade ${grade} student can follow.
Use Markdown where helpful.`;

        if (style === 'simple') {
          base += `
STYLE: SIMPLE.
- Answer as SHORT as possible.
- If it's a question with a clear answer, give that answer directly and (at most) one very short sentence.
- No long intros, no extra paragraphs.`;
        } else if (style === 'steps') {
          base += `
STYLE: STEP-BY-STEP.
- Break the solution or explanation into clear, numbered steps.
- Explain your reasoning slowly.`;
        } else if (style === 'visual') {
          base += `
STYLE: VISUAL.
- Use comparisons, simple diagrams in text, and vivid descriptions.
- Help the student picture what is happening.`;
        }

        return base;
      };

      // ========= AI HELPERS =========
      const analyzeWritingStyle = async (samples) => {
        const system = `
You are YAI, a writing coach.
You will analyze a student's writing and create a short "Writing Style Profile".
This profile should help future answers sound closer to the student's natural style,
but must NOT try to bypass AI detectors or imitate mistakes on purpose.
Focus on tone, sentence length, level of formality, and vocabulary.`;
        const user = `Here is the student's writing. Summarize their style in 5â€“8 bullet points:

"${samples}"`;
        return await callOpenRouter({ system, user, history: [] });
      };

      const generateQuizData = async (topic, grade, weakAreas = null) => {
        const system = `
You are a Quiz Generator for a Grade ${grade} student.
Create honest practice questions that help them learn.`;
        const user = `
USER REQUEST/TOPIC:
"${topic}"

${weakAreas ? `FOCUS MORE ON THESE WEAK AREAS: ${weakAreas}` : ''}

INSTRUCTIONS:
1. If the user writes a number like "10 questions" or "3 questions", use exactly that many.
2. If no number is given, generate exactly 5 questions.
3. Each question must be multiple-choice with 4 options.
4. Include "correctAnswerIndex" (0-3) and a short "explanation".
5. Return ONLY raw JSON (no extra text, no markdown), in this format:

[
  {
    "question": "string",
    "options": ["string", "string", "string", "string"],
    "correctAnswerIndex": 0,
    "explanation": "string"
  }
]
`;
        let text = await callOpenRouter({ system, user, history: [] });
        text = text.trim();
        if (text.startsWith("```")) {
          text = text.replace(/^```json/i, '')
                     .replace(/^```/, '')
                     .replace(/```$/, '')
                     .trim();
        }
        return JSON.parse(text);
      };

      const generateQuizSummary = async (quizData, score, wrongIndexes, grade) => {
        const system = `
You are a friendly tutor summarizing quiz results for a Grade ${grade} student.
Explain gently how they did and what to focus on next.`;
        const user = `
The student took this quiz:

${JSON.stringify(quizData, null, 2)}

Their score: ${score} out of ${quizData.length}.
They missed questions at indexes (0-based): [${wrongIndexes.join(', ')}].

1. Give a short summary of how they did.
2. Mention the main topics they should review.
3. Encourage them with 1â€“2 positive sentences.
Use Markdown and keep it short.`;
        return await callOpenRouter({ system, user, history: [] });
      };

      const generateQuestionHint = async (questionObj, grade) => {
        const system = `
You are a helpful tutor for Grade ${grade}.
You give hints for quiz questions without giving away the answer.`;
        const user = `
Here is a multiple-choice question:

${JSON.stringify(questionObj, null, 2)}

Give ONE short hint that helps the student think, but do NOT say which option is correct and do not reveal the exact answer.`;
        return await callOpenRouter({ system, user, history: [] });
      };

      const generateThemeFromDescription = async (description) => {
        const system = `
You are a simple theme generator.
Given a student description, you choose a nice accent color and optional glow color.
Return ONLY JSON like:
{
  "name": "string",
  "accent": "#RRGGBB",
  "glow": "#RRGGBB"
}
Colors should be dark-theme friendly.`;
        const user = `Theme description from the student: "${description}"`;
        let text = await callOpenRouter({ system, user, history: [] });
        text = text.trim();
        if (text.startsWith("```")) {
          text = text.replace(/^```json/i, '')
                     .replace(/^```/, '')
                     .replace(/```$/, '')
                     .trim();
        }
        try {
          return JSON.parse(text);
        } catch {
          return { ...defaultTheme, name: "Custom" };
        }
      };

      // ========= UI COMPONENTS =========
      const MessageBubble = ({ message }) => {
        const isUser = message.role === 'user';
        const isError = message.isError;

        return (
          <div className={`flex w-full mb-4 ${isUser ? 'justify-end' : 'justify-start'}`}>
            <div className={`flex max-w-[85%] md:max-w-[75%] gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>
              <div className={`flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center overflow-hidden ${
                isUser ? 'bg-brand-600' : isError ? 'bg-red-500' : 'bg-gray-700'
              }`}>
                {isUser ? <User size={16} className="text-white" /> :
                 isError ? <AlertCircle size={16} className="text-white" /> :
                 <Bot size={16} className="text-brand-300" />}
              </div>
              <div className={`flex flex-col ${isUser ? 'items-end' : 'items-start'}`}>
                <div
                  className={`px-4 py-3 rounded-2xl shadow-sm text-sm md:text-base leading-relaxed overflow-hidden ${
                    isUser
                      ? 'bg-brand-600 text-white rounded-tr-sm'
                      : isError
                      ? 'bg-red-900/50 border border-red-800 text-red-200 rounded-tl-sm'
                      : 'bg-gray-800 text-gray-100 border border-gray-700 rounded-tl-sm'
                  }`}
                >
                  {isError ? (
                    <span>{message.content}</span>
                  ) : (
                    <div className="markdown-body">
                      <ReactMarkdown
                        components={{
                          code({ className, children, ...props }) {
                            const match = /language-(\w+)/.exec(className || '');
                            const isInline = !match && !String(children).includes('\n');
                            if (isInline) {
                              return (
                                <code className="bg-black/20 px-1 py-0.5 rounded font-mono text-xs" {...props}>
                                  {children}
                                </code>
                              );
                            }
                            return (
                              <div className="relative my-2 overflow-hidden rounded-md bg-gray-950 border border-brand-900/50">
                                <div className="flex items-center justify-between px-3 py-1 bg-gray-900 border-b border-gray-800">
                                  <span className="text-xs text-gray-400 font-mono lowercase">
                                    {match ? match[1] : 'code'}
                                  </span>
                                </div>
                                <pre className="p-3 overflow-x-auto text-sm font-mono text-gray-300">
                                  <code className={className} {...props}>{children}</code>
                                </pre>
                              </div>
                            );
                          },
                        }}
                      >
                        {message.content}
                      </ReactMarkdown>
                    </div>
                  )}
                </div>
                <span className="text-xs text-gray-500 mt-1 px-1">
                  {new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </span>
              </div>
            </div>
          </div>
        );
      };

      const ChatInput = ({ onSend, disabled, showStyles = true, placeholder, selectedStyle, onStyleChange }) => {
        const [text, setText] = useState('');
        const [selectedImage, setSelectedImage] = useState(null);
        const textareaRef = useRef(null);
        const fileInputRef = useRef(null);

        const adjustHeight = () => {
          const textarea = textareaRef.current;
          if (textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${Math.min(textarea.scrollHeight, 150)}px`;
          }
        };

        useEffect(() => { adjustHeight(); }, [text]);

        const handleSubmit = () => {
          if ((text.trim() || selectedImage) && !disabled) {
            onSend(text.trim(), selectedImage);
            setText('');
            setSelectedImage(null);
            if (textareaRef.current) textareaRef.current.style.height = 'auto';
            if (fileInputRef.current) fileInputRef.current.value = '';
          }
        };

        const handleKeyDown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
          }
        };

        const handleFileChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => setSelectedImage(reader.result);
            reader.readAsDataURL(file);
          }
        };

        const styles = [
          { id: 'simple', label: 'Simple', icon: <Baby size={16} />, desc: 'Answer only' },
          { id: 'steps', label: 'Steps', icon: <ListOrdered size={16} />, desc: 'Step-by-step' },
          { id: 'visual', label: 'Visual', icon: <ImageIcon size={16} />, desc: 'Imagery & diagrams' },
        ];

        return (
          <div className="w-full bg-[#020617] border-t border-gray-800 p-4 pb-6">
            <div className="max-w-4xl mx-auto space-y-3">
              {showStyles && (
                <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                  {styles.map((style) => (
                    <button
                      key={style.id}
                      onClick={() => onStyleChange(style.id)}
                      disabled={disabled}
                      className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs md:text-sm font-medium transition-all border ${
                        selectedStyle === style.id
                          ? 'bg-brand-600 border-brand-500 text-white shadow-md shadow-brand-900/20'
                          : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-750 hover:border-gray-600'
                      }`}
                    >
                      {style.icon}
                      <span className="leading-none">{style.label}</span>
                    </button>
                  ))}
                </div>
              )}

              {selectedImage && (
                <div className="relative inline-block mb-2">
                  <img
                    src={selectedImage}
                    alt="Preview"
                    className="h-20 w-20 object-cover rounded-lg border border-gray-600"
                  />
                  <button
                    onClick={() => { setSelectedImage(null); if (fileInputRef.current) fileInputRef.current.value = ''; }}
                    className="absolute -top-2 -right-2 bg-gray-700 text-white rounded-full p-1 hover:bg-red-500 transition-colors shadow-sm"
                  >
                    <X size={12} />
                  </button>
                </div>
              )}

              <div className="relative flex items-end gap-2 bg-gray-800 p-2 rounded-2xl border border-gray-700 shadow-lg focus-within:ring-2 focus-within:ring-brand-500/50 focus-within:border-brand-500 transition-all">
                <input
                  type="file"
                  ref={fileInputRef}
                  className="hidden"
                  accept="image/*"
                  onChange={handleFileChange}
                />
                <button
                  onClick={() => fileInputRef.current?.click()}
                  disabled={disabled}
                  className="p-2 rounded-xl text-gray-400 hover:text-gray-200 hover:bg-gray-700 transition-colors"
                  title="(Optional) attach image"
                >
                  <Paperclip size={18} />
                </button>

                <textarea
                  ref={textareaRef}
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder={placeholder || "Ask YAI anything..."}
                  disabled={disabled}
                  rows={1}
                  className="w-full bg-transparent text-gray-100 placeholder-gray-500 text-base p-2 resize-none focus:outline-none max-h-[150px] overflow-y-auto custom-scrollbar disabled:opacity-50"
                  style={{ minHeight: '40px' }}
                />
                <button
                  onClick={handleSubmit}
                  disabled={(!text.trim() && !selectedImage) || disabled}
                  className={`p-3 rounded-xl flex-shrink-0 transition-all duration-200 ${
                    (text.trim() || selectedImage) && !disabled
                      ? 'bg-brand-600 text-white hover:bg-brand-500 shadow-lg hover:scale-105 active:scale-95'
                      : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  {disabled ? <Loader2 className="animate-spin" size={20} /> : <Send size={20} />}
                </button>
              </div>
            </div>
          </div>
        );
      };

      const TypingIndicator = () => (
        <div className="flex w-full mb-4 justify-start">
          <div className="flex max-w-[85%] md:max-w-[75%] gap-3 flex-row">
            <div className="flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center bg-emerald-600 animate-pulse">
              <div className="h-2 w-2 bg-white rounded-full" />
            </div>
            <div className="flex items-center">
              <span className="text-sm text-gray-400 italic">Thinking...</span>
            </div>
          </div>
        </div>
      );

      // ========= SIDEBAR =========
      const Sidebar = ({
        currentView,
        onViewChange,
        grade,
        onGradeChange,
        conversations,
        activeConversationId,
        onSelectConversation,
        onNewConversation
      }) => {
        const homeworkConvs = conversations.filter(c => c.mode === 'homework');
        const essayConvs = conversations.filter(c => c.mode === 'essay');
        const sectionConvs = currentView === 'essay' ? essayConvs : homeworkConvs;

        return (
          <aside className="w-64 bg-gray-950 border-r border-gray-800 flex flex-col">
            <div className="px-4 pt-4 pb-3 border-b border-gray-800">
              <div className="flex items-center gap-2 mb-3">
                <div className="bg-gradient-to-br from-indigo-600 to-violet-600 p-2 rounded-xl shadow-lg shadow-indigo-900/20">
                  <GraduationCap className="text-white h-5 w-5" />
                </div>
                <div>
                  <h1 className="font-bold text-gray-100 text-sm">YAI Study Helper</h1>
                  <p className="text-[11px] text-gray-500">Your AI buddy for anything</p>
                </div>
              </div>

              <div className="flex flex-col gap-1">
                <button
                  onClick={() => onViewChange('homework')}
                  className={`w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-sm ${
                    currentView === 'homework'
                      ? 'bg-gray-800 text-white'
                      : 'text-gray-400 hover:bg-gray-900 hover:text-gray-100'
                  }`}
                >
                  <BookOpen size={14} />
                  <span>Homework / Chat</span>
                </button>
                <button
                  onClick={() => onViewChange('essay')}
                  className={`w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-sm ${
                    currentView === 'essay'
                      ? 'bg-gray-800 text-white'
                      : 'text-gray-400 hover:bg-gray-900 hover:text-gray-100'
                  }`}
                >
                  <PenTool size={14} />
                  <span>Writing Helper</span>
                </button>
                <button
                  onClick={() => onViewChange('quiz')}
                  className={`w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-sm ${
                    currentView === 'quiz'
                      ? 'bg-gray-800 text-white'
                      : 'text-gray-400 hover:bg-gray-900 hover:text-gray-100'
                  }`}
                >
                  <BrainCircuit size={14} />
                  <span>Quiz</span>
                </button>
                <button
                  onClick={() => onViewChange('settings')}
                  className={`w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-sm ${
                    currentView === 'settings'
                      ? 'bg-gray-800 text-white'
                      : 'text-gray-400 hover:bg-gray-900 hover:text-gray-100'
                  }`}
                >
                  <SettingsIcon size={14} />
                  <span>Settings</span>
                </button>
              </div>
            </div>

            <div className="px-4 py-2 border-b border-gray-800 flex items-center justify-between text-xs text-gray-400">
              <span>GRADE</span>
              <select
                value={grade}
                onChange={(e) => onGradeChange(Number(e.target.value))}
                className="bg-gray-900 border border-gray-700 text-gray-300 text-xs rounded-lg focus:ring-brand-500 focus:border-brand-500 px-2 py-1 outline-none cursor-pointer"
              >
                <option value={8}>8</option>
                <option value={9}>9</option>
                <option value={10}>10</option>
                <option value={11}>11</option>
                <option value={12}>12</option>
              </select>
            </div>

            {(currentView === 'homework' || currentView === 'essay') && (
              <div className="flex-1 flex flex-col overflow-hidden">
                <div className="px-4 pt-3 pb-2 flex items-center justify-between text-xs text-gray-400">
                  <span>{currentView === 'essay' ? 'Writing chats' : 'Chats'}</span>
                  <button
                    onClick={() => onNewConversation(currentView)}
                    className="flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-gray-800 hover:bg-gray-700 text-gray-200"
                  >
                    <Plus size={12} />
                    <span>New</span>
                  </button>
                </div>
                <div className="flex-1 overflow-y-auto custom-scrollbar px-2 pb-4">
                  {sectionConvs.length === 0 && (
                    <p className="text-[11px] text-gray-500 px-2">
                      No chats yet. Start typing to create one.
                    </p>
                  )}
                  {sectionConvs.map(conv => (
                    <button
                      key={conv.id}
                      onClick={() => onSelectConversation(conv.id)}
                      className={`w-full text-left px-2 py-2 rounded-lg mb-1 text-xs ${
                        conv.id === activeConversationId
                          ? 'bg-gray-800 border border-brand-600 text-gray-100'
                          : 'bg-transparent hover:bg-gray-900 border border-transparent text-gray-400 hover:text-gray-100'
                      }`}
                    >
                      <div className="flex justify-between items-center mb-0.5">
                        <span className="font-semibold truncate">
                          {conv.title || (conv.mode === 'essay' ? 'Writing Chat' : 'Chat')}
                        </span>
                        <span className="text-[10px] text-gray-500">
                          {new Date(conv.updatedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </span>
                      </div>
                      {conv.lastMessage && (
                        <p className="text-[11px] text-gray-500 truncate">
                          {conv.lastMessage}
                        </p>
                      )}
                    </button>
                  ))}
                </div>
              </div>
            )}

            <div className="px-4 py-3 border-t border-gray-800 text-[11px] text-gray-500">
              <p>Chats & theme are saved only on this device.</p>
            </div>
          </aside>
        );
      };

      // ========= HOMEWORK / GENERAL CHAT =========
      const HomeworkChat = ({ grade, conversation, onUpdateConversation }) => {
        const [messages, setMessages] = useState(conversation.messages || []);
        const [isProcessing, setIsProcessing] = useState(false);
        const [style, setStyle] = useState('simple');
        const messagesEndRef = useRef(null);

        useEffect(() => {
          setMessages(conversation.messages || []);
        }, [conversation.id]);

        useEffect(() => {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages, isProcessing]);

        useEffect(() => {
          onUpdateConversation({
            ...conversation,
            messages,
            lastMessage: messages[messages.length - 1]?.content?.slice(0, 50) || '',
            updatedAt: Date.now()
          });
        }, [messages]);

        const handleSendMessage = useCallback(async (text, image) => {
          if (!text.trim() && !image) return;

          const userMessage = {
            id: uuidv4(),
            role: 'user',
            content: text,
            image,
            timestamp: Date.now(),
          };

          setMessages(prev => [...prev, userMessage]);
          setIsProcessing(true);

          const styleInstruction =
            style === 'simple'
              ? "(Answer with just the answer or one very short sentence. No extra fluff.)"
              : style === 'steps'
              ? "(Explain step-by-step using numbered steps.)"
              : "(Explain in a visual way with comparisons and simple text diagrams.)";

          const system = getSystemInstruction(grade, style, 'homework');
          const userPrompt = `${styleInstruction}\n\n${text}`;

          const placeholderMessage = {
            id: uuidv4(),
            role: 'model',
            content: "",
            timestamp: Date.now(),
            isStreaming: true,
          };
          const modelId = placeholderMessage.id;
          setMessages(prev => [...prev, placeholderMessage]);

          try {
            const reply = await callOpenRouter({
              system,
              user: userPrompt,
              history: [...messages, userMessage]
            });
            setMessages(prev =>
              prev.map(msg =>
                msg.id === modelId
                  ? { ...msg, content: reply, isStreaming: false }
                  : msg
              )
            );
          } catch (error) {
            console.error("Chat error:", error);
            const errorText = isRateLimitError(error)
              ? "**The AI is busy or rate-limited right now. Please try again in a bit.**"
              : "Sorry, something went wrong answering that.";
            setMessages(prev =>
              prev.map(msg =>
                msg.id === modelId
                  ? { ...msg, content: errorText, isStreaming: false, isError: true }
                  : msg
              )
            );
          } finally {
            setIsProcessing(false);
          }
        }, [style, grade, messages]);

        const handleClear = () => {
          if (!confirm('Start a brand new chat?')) return;
          const greeting = {
            id: uuidv4(),
            role: 'model',
            content: `Hi! I'm YAI. ðŸ‘‹\n\nI'm set to **Grade ${grade}** level. You can talk to me about homework, hobbies, questions, or anything on your mind (as long as it's safe).`,
            timestamp: Date.now(),
          };
          setMessages([greeting]);
        };

        return (
          <div className="flex flex-col h-full relative">
            <div className="absolute top-3 right-3 z-20">
              <button
                onClick={handleClear}
                className="p-2 bg-gray-800/80 hover:bg-red-500/20 text-gray-400 hover:text-red-400 rounded-full transition-all border border-gray-700"
              >
                <Trash2 size={16} />
              </button>
            </div>

            <div className="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 scroll-smooth">
              <div className="max-w-4xl mx-auto flex flex-col justify-end min-h-full">
                {messages.map((msg) => (
                  <MessageBubble key={msg.id} message={msg} />
                ))}
                {isProcessing &&
                  messages.length > 0 &&
                  messages[messages.length - 1].role === 'user' && (
                    <TypingIndicator />
                  )}
                <div ref={messagesEndRef} className="h-4" />
              </div>
            </div>
            <ChatInput
              onSend={(text, img) => handleSendMessage(text, img)}
              disabled={isProcessing}
              selectedStyle={style}
              onStyleChange={setStyle}
            />
          </div>
        );
      };

      // ========= WRITING HELPER =========
      const EssayMimic = ({ grade, conversation, onUpdateConversation }) => {
        const [step, setStep] = useState(conversation.styleProfile ? 'chat' : 'input');
        const [samples, setSamples] = useState('');
        const [isAnalyzing, setIsAnalyzing] = useState(false);
        const [styleProfile, setStyleProfile] = useState(conversation.styleProfile || '');
        const [messages, setMessages] = useState(conversation.messages || []);
        const [isProcessing, setIsProcessing] = useState(false);
        const messagesEndRef = useRef(null);

        useEffect(() => {
          setMessages(conversation.messages || []);
          setStyleProfile(conversation.styleProfile || '');
          setStep(conversation.styleProfile ? 'chat' : 'input');
        }, [conversation.id]);

        useEffect(() => {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages, isProcessing]);

        useEffect(() => {
          onUpdateConversation({
            ...conversation,
            messages,
            styleProfile,
            lastMessage: messages[messages.length - 1]?.content?.slice(0, 50) || '',
            updatedAt: Date.now()
          });
        }, [messages, styleProfile]);

        const handleAnalyze = async () => {
          if (!samples.trim()) return;
          setIsAnalyzing(true);
          try {
            const result = await analyzeWritingStyle(samples);
            if (result) {
              setStyleProfile(result);
              const intro = {
                id: uuidv4(),
                role: 'model',
                content: `**Style Learned!** ðŸ§¬\n\nHere is your writing style profile:\n\n${result}\n\nNow tell me what you want to write (for example: "Write a 3-paragraph essay about why homework matters") and I will help while keeping a similar tone.`,
                timestamp: Date.now(),
              };
              setMessages([intro]);
              setStep('chat');
            }
          } catch (error) {
            console.error("Analysis failed", error);
            alert("Analysis failed. Try again.");
          } finally {
            setIsAnalyzing(false);
          }
        };

        const handleReset = () => {
          if (!confirm("Forget this style and start over?")) return;
          setSamples('');
          setStyleProfile('');
          setMessages([]);
          setStep('input');
        };

        const handleSendMessage = useCallback(async (text) => {
          if (!text.trim()) return;

          const userMessage = {
            id: uuidv4(),
            role: 'user',
            content: text,
            timestamp: Date.now(),
          };
          setMessages(prev => [...prev, userMessage]);
          setIsProcessing(true);

          const system = getSystemInstruction(grade, 'simple', 'essay') +
            `\n\nHere is the student's writing style profile:\n${styleProfile}`;
          const user = `Write or improve what the student is asking for. Keep it in their general style, but still clear and appropriate for school.\n\nStudent request: ${text}`;

          const placeholder = {
            id: uuidv4(),
            role: 'model',
            content: '',
            timestamp: Date.now(),
            isStreaming: true,
          };
          const modelId = placeholder.id;
          setMessages(prev => [...prev, placeholder]);

          try {
            const reply = await callOpenRouter({
              system,
              user,
              history: [...messages, userMessage]
            });
            setMessages(prev =>
              prev.map(msg =>
                msg.id === modelId
                  ? { ...msg, content: reply, isStreaming: false }
                  : msg
              )
            );
          } catch (error) {
            console.error("Essay chat error:", error);
            const textErr = isRateLimitError(error)
              ? "**The AI is busy right now. Please try again in a bit.**"
              : "Sorry, something went wrong while generating writing help.";
            setMessages(prev =>
              prev.map(msg =>
                msg.id === modelId
                  ? { ...msg, content: textErr, isStreaming: false, isError: true }
                  : msg
              )
            );
          } finally {
            setIsProcessing(false);
          }
        }, [styleProfile, grade, messages]);

        if (step === 'input') {
          return (
            <div className="max-w-3xl mx-auto p-6 md:p-12 flex flex-col h-full overflow-y-auto">
              <div className="text-center mb-8">
                <div className="inline-flex items-center justify-center p-3 bg-purple-600 rounded-2xl mb-4 shadow-lg shadow-purple-900/40">
                  <PenTool className="text-white h-8 w-8" />
                </div>
                <h2 className="text-3xl font-bold text-gray-100 mb-2">Writing Helper (Style Match)</h2>
                <p className="text-gray-400 max-w-lg mx-auto">
                  Paste a few paragraphs of your own writing. YAI will learn your tone and help you write new essays that still sound like you â€” while keeping things honest and school-safe.
                </p>
              </div>

              <div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl mb-6">
                <label className="block text-sm font-medium text-gray-300 mb-2 flex items-center gap-2">
                  <Sparkles size={16} className="text-yellow-500" />
                  Paste 3â€“4 paragraphs of YOUR writing:
                </label>
                <textarea
                  value={samples}
                  onChange={(e) => setSamples(e.target.value)}
                  placeholder="Write a few paragraphs here in your own words..."
                  className="w-full h-64 bg-gray-950 border border-gray-800 rounded-xl p-4 text-gray-200 focus:ring-2 focus:ring-purple-500/50 outline-none resize-none custom-scrollbar leading-relaxed"
                />
              </div>

              <button
                onClick={handleAnalyze}
                disabled={isAnalyzing || samples.length < 20}
                className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all flex items-center justify-center gap-2 ${
                  isAnalyzing || samples.length < 20
                    ? 'bg-gray-800 text-gray-500 cursor-not-allowed'
                    : 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white transform hover:scale-[1.01]'
                }`}
              >
                {isAnalyzing ? <RefreshCw className="animate-spin" /> : "Analyze My Style"}
              </button>
            </div>
          );
        }

        return (
          <div className="flex flex-col h-full relative">
            <div className="absolute top-3 right-3 z-20 flex gap-2">
              <div className="hidden md:flex items-center gap-2 bg-gray-900/90 border border-purple-500/30 px-3 py-1.5 rounded-full backdrop-blur-sm">
                <Check size={14} className="text-green-400" />
                <span className="text-xs text-purple-200 font-medium">Style Active</span>
              </div>
              <button
                onClick={handleReset}
                className="p-2 bg-gray-800/80 hover:bg-red-500/20 text-gray-400 hover:text-red-400 rounded-full border border-gray-700"
              >
                <Trash2 size={16} />
              </button>
            </div>

            <div className="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 scroll-smooth">
              <div className="max-w-4xl mx-auto flex flex-col justify-end min-h-full">
                {messages.map((msg) => (
                  <MessageBubble key={msg.id} message={msg} />
                ))}
                {isProcessing &&
                  messages.length > 0 &&
                  messages[messages.length - 1].role === 'user' && (
                    <TypingIndicator />
                  )}
                <div ref={messagesEndRef} className="h-4" />
              </div>
            </div>

            <ChatInput
              onSend={(text) => handleSendMessage(text)}
              disabled={isProcessing}
              showStyles={false}
              placeholder="What should I write or improve? (I'll keep your style)"
            />
          </div>
        );
      };

      // ========= QUIZ MODE =========
      const QuizMode = ({ grade }) => {
        const [step, setStep] = useState('input');
        const [inputTopic, setInputTopic] = useState('');
        const [quizData, setQuizData] = useState([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [score, setScore] = useState(0);
        const [showExplanation, setShowExplanation] = useState(false);
        const [selectedAnswer, setSelectedAnswer] = useState(null);
        const [wrongIndexes, setWrongIndexes] = useState([]);
        const [historyQuestions, setHistoryQuestions] = useState([]);
        const [isSummaryLoading, setIsSummaryLoading] = useState(false);
        const [summary, setSummary] = useState('');
        const [isHintLoading, setIsHintLoading] = useState(false);
        const [hint, setHint] = useState('');

        const handleGenerate = async (topic, weakAreas = null) => {
          setStep('loading');
          try {
            const data = await generateQuizData(topic, grade, weakAreas);
            setQuizData(data);
            setCurrentIndex(0);
            setScore(0);
            setShowExplanation(false);
            setSelectedAnswer(null);
            setWrongIndexes([]);
            setHistoryQuestions([]);
            setSummary('');
            setHint('');
            setStep('quiz');
          } catch (error) {
            console.error(error);
            setStep('input');
            alert("Failed to generate quiz. Please try again.");
          }
        };

        const handleAnswer = (index) => {
          setSelectedAnswer(index);
          setShowExplanation(true);
          const isCorrect = index === quizData[currentIndex].correctAnswerIndex;
          if (isCorrect) {
            setScore(s => s + 1);
          } else {
            setWrongIndexes(prev => [...prev, currentIndex]);
            setHistoryQuestions(h => [...h, quizData[currentIndex].question]);
          }
        };

        const nextQuestion = () => {
          setHint('');
          if (currentIndex < quizData.length - 1) {
            setCurrentIndex(c => c + 1);
            setSelectedAnswer(null);
            setShowExplanation(false);
          } else {
            setStep('results');
            handleSummary();
          }
        };

        const handleSummary = async () => {
          if (!quizData.length || summary || isSummaryLoading) return;
          setIsSummaryLoading(true);
          try {
            const text = await generateQuizSummary(quizData, score, wrongIndexes, grade);
            setSummary(text);
          } catch (e) {
            console.error("Summary error:", e);
            setSummary("Couldn't generate a summary this time, but you can look at which questions you missed and review those topics.");
          } finally {
            setIsSummaryLoading(false);
          }
        };

        const handleHint = async () => {
          if (!quizData[currentIndex] || isHintLoading) return;
          setIsHintLoading(true);
          setHint('');
          try {
            const h = await generateQuestionHint(quizData[currentIndex], grade);
            setHint(h);
          } catch (e) {
            console.error("Hint error:", e);
            setHint("Hint is not available right now.");
          } finally {
            setIsHintLoading(false);
          }
        };

        if (step === 'input') {
          return (
            <div className="max-w-2xl mx-auto p-6 md:p-12">
              <div className="text-center mb-8">
                <div className="inline-flex items-center justify-center p-3 bg-indigo-600 rounded-2xl mb-4 shadow-lg shadow-indigo-900/40">
                  <BrainCircuit className="text-white h-8 w-8" />
                </div>
                <h2 className="text-3xl font-bold text-gray-100 mb-2">Quiz Generator</h2>
                <p className="text-gray-400">
                  Paste your notes, a topic, or even a dream job (like "Lawyer") and YAI will make a custom quiz.
                </p>
              </div>
              <div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl mb-6">
                <textarea
                  value={inputTopic}
                  onChange={(e) => setInputTopic(e.target.value)}
                  placeholder="E.g., 'Grass is green, rocks erode' or 'Make me 10 questions on 8th grade Biology'..."
                  className="w-full h-40 bg-gray-950 border border-gray-800 rounded-xl p-4 text-gray-200 focus:ring-2 focus:ring-indigo-500/50 outline-none resize-none"
                />
              </div>
              <button
                onClick={() => handleGenerate(inputTopic)}
                disabled={!inputTopic.trim()}
                className="w-full py-4 rounded-xl font-bold text-lg bg-brand-600 hover:bg-brand-500 text-white shadow-lg transition-transform hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Generate Quiz
              </button>
            </div>
          );
        }

        if (step === 'loading') {
          return (
            <div className="flex flex-col items-center justify-center h-full">
              <div className="relative">
                <BrainCircuit size={64} className="text-brand-500 animate-pulse" />
                <div className="absolute inset-0 bg-brand-500/20 blur-xl rounded-full animate-pulse-slow"></div>
              </div>
              <p className="mt-6 text-xl font-bold text-gray-200 animate-bounce-slight">Building your Quiz...</p>
              <p className="text-sm text-gray-500 mt-2">Creating questions & answer choices</p>
            </div>
          );
        }

        if (step === 'results') {
          return (
            <div className="max-w-xl mx-auto p-6 md:p-10 flex flex-col h-full overflow-y-auto custom-scrollbar">
              <h2 className="text-3xl font-bold text-white mb-2 text-center">Quiz Complete!</h2>
              <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-brand-400 to-indigo-400 my-4 text-center">
                {score}/{quizData.length}
              </div>
              <p className="text-gray-300 mb-4 text-center">
                {score === quizData.length
                  ? "Perfect score! That's amazing ðŸŒŸ"
                  : "Nice work! Check the summary below to see what to practice."}
              </p>

              <div className="mt-4 mb-6">
                <h3 className="text-lg font-semibold text-gray-100 mb-2 flex items-center gap-2">
                  <Bot size={16} className="text-brand-400" />
                  AI Summary & Hints
                </h3>
                <div className="bg-gray-900 border border-gray-800 rounded-xl p-4 text-sm text-gray-200 min-h-[80px]">
                  {isSummaryLoading && <p>Thinking about your results...</p>}
                  {!isSummaryLoading && summary && (
                    <ReactMarkdown className="markdown-body text-sm">
                      {summary}
                    </ReactMarkdown>
                  )}
                  {!isSummaryLoading && !summary && (
                    <p className="text-gray-400">
                      No summary yet. (If something went wrong, just try another quiz!)
                    </p>
                  )}
                </div>
              </div>

              <div className="space-y-3 mt-auto">
                {score < quizData.length && (
                  <button
                    onClick={() => handleGenerate(inputTopic, historyQuestions.join(', '))}
                    className="w-full py-3 rounded-xl font-bold bg-indigo-600 hover:bg-indigo-500 text-white"
                  >
                    Practice Weak Spots
                  </button>
                )}
                <button
                  onClick={() => { setStep('input'); setInputTopic(''); }}
                  className="w-full py-3 rounded-xl font-bold bg-gray-800 hover:bg-gray-700 text-gray-300"
                >
                  New Quiz
                </button>
              </div>
            </div>
          );
        }

        const question = quizData[currentIndex];
        return (
          <div className="max-w-2xl mx-auto p-4 md:p-8 flex flex-col h-full justify-center">
            <div className="mb-4 flex justify-between items-center text-gray-500 text-sm font-medium">
              <span>Question {currentIndex + 1} of {quizData.length}</span>
              <span className="bg-gray-800 px-3 py-1 rounded-full">Score: {score}</span>
            </div>

            <div className="w-full bg-gray-800 rounded-full h-2 mb-6 overflow-hidden">
              <div
                className="h-2 bg-gradient-to-r from-brand-500 to-indigo-500 transition-all"
                style={{ width: `${((currentIndex) / quizData.length) * 100}%` }}
              />
            </div>

            <h3 className="text-2xl font-bold text-white mb-6 leading-snug">{question.question}</h3>

            <div className="space-y-3 mb-4">
              {question.options.map((opt, idx) => {
                let stateClass = 'bg-gray-800 border-gray-700 hover:bg-gray-750';
                if (selectedAnswer !== null) {
                  if (idx === question.correctAnswerIndex) stateClass = 'bg-green-900/40 border-green-500 text-green-100';
                  else if (idx === selectedAnswer) stateClass = 'bg-red-900/40 border-red-500 text-red-100';
                  else stateClass = 'bg-gray-900/50 border-gray-800 text-gray-500';
                }

                return (
                  <button
                    key={idx}
                    onClick={() => !showExplanation && handleAnswer(idx)}
                    disabled={showExplanation}
                    className={`w-full text-left p-3 rounded-xl border transition-all ${stateClass} ${!showExplanation && 'hover:scale-[1.01] active:scale-[0.99]'}`}
                  >
                    <div className="flex items-center">
                      <span className="w-8 h-8 rounded-full bg-black/20 flex items-center justify-center mr-3 text-sm font-mono opacity-70">
                        {String.fromCharCode(65 + idx)}
                      </span>
                      {opt}
                    </div>
                  </button>
                );
              })}
            </div>

            {!showExplanation && (
              <div className="flex items-center justify-between mt-2 mb-4 text-xs">
                <button
                  onClick={handleHint}
                  disabled={isHintLoading}
                  className="flex items-center gap-1 text-brand-300 hover:text-brand-200"
                >
                  <Sparkles size={14} />
                  {isHintLoading ? "Getting hint..." : "AI Hint"}
                </button>
                <span className="text-gray-500">Try your best before checking the explanation!</span>
              </div>
            )}

            {hint && (
              <div className="bg-gray-900 border border-brand-500/30 rounded-xl p-3 mb-3 text-sm text-gray-200">
                <span className="font-semibold text-brand-300 text-xs flex items-center gap-1 mb-1">
                  <Sparkles size={12} /> Hint
                </span>
                <ReactMarkdown className="markdown-body text-sm">
                  {hint}
                </ReactMarkdown>
              </div>
            )}

            {showExplanation && (
              <div className="bg-brand-900/20 border border-brand-500/30 p-4 rounded-xl animate-fadeIn mt-2">
                <div className="flex items-center gap-2 mb-2 text-brand-300 font-bold text-sm">
                  <Bot size={16} /> Explanation
                </div>
                <p className="text-gray-300 text-sm">{question.explanation}</p>
                <button
                  onClick={nextQuestion}
                  className="mt-4 w-full py-2 bg-brand-600 hover:bg-brand-500 text-white rounded-lg font-bold"
                >
                  {currentIndex < quizData.length - 1 ? 'Next Question' : 'Finish Quiz'}
                </button>
              </div>
            )}
          </div>
        );
      };

      // ========= SETTINGS =========
      const SettingsView = ({ theme, onGenerateTheme, isGeneratingTheme }) => {
        const [description, setDescription] = useState('');

        return (
          <div className="max-w-3xl mx-auto p-6 md:p-10 space-y-8 h-full overflow-y-auto custom-scrollbar">
            <div>
              <h2 className="text-2xl font-bold text-gray-100 mb-2 flex items-center gap-2">
                <SettingsIcon size={18} /> Settings
              </h2>
              <p className="text-gray-400 text-sm">
                Tweak how YAI looks and behaves. (More settings can be added later.)
              </p>
            </div>

            <div className="bg-gray-900 border border-gray-800 rounded-2xl p-5 space-y-4">
              <div className="flex items-center justify-between gap-4">
                <div>
                  <h3 className="text-base font-semibold text-gray-100 flex items-center gap-2">
                    <Sparkles size={16} className="text-yellow-400" />
                    Beta AI Theme
                  </h3>
                  <p className="text-xs text-gray-400">
                    Describe your vibe and YAI will pick colors. This is only for you and saved on this device.
                  </p>
                </div>
                <div className="flex items-center gap-2">
                  <div
                    className="w-8 h-8 rounded-full border border-gray-700"
                    style={{ background: theme.accent }}
                  ></div>
                  <div
                    className="w-8 h-8 rounded-full border border-gray-700"
                    style={{ background: theme.glow }}
                  ></div>
                </div>
              </div>

              <textarea
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="Example: neon cyberpunk purple/blue, or soft pastel sky, or dark forest green..."
                className="w-full h-24 bg-gray-950 border border-gray-800 rounded-xl p-3 text-sm text-gray-200 focus:ring-2 focus:ring-brand-500/50 outline-none resize-none"
              />

              <button
                onClick={() => onGenerateTheme(description)}
                disabled={!description.trim() || isGeneratingTheme}
                className="px-4 py-2 rounded-lg text-sm font-semibold bg-brand-600 hover:bg-brand-500 text-white disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
              >
                {isGeneratingTheme ? <Loader2 className="animate-spin" size={16} /> : <Sparkles size={16} />}
                {isGeneratingTheme ? "Asking AI for theme..." : "Generate Theme with AI"}
              </button>

              <p className="text-xs text-gray-500">
                Current theme: <span className="text-gray-200 font-semibold">{theme.name}</span>
              </p>
            </div>

            <div className="bg-gray-900 border border-gray-800 rounded-2xl p-5">
              <h3 className="text-base font-semibold text-gray-100 mb-1">About YAI</h3>
              <p className="text-xs text-gray-400">
                YAI is here to help you understand things, not to do everything for you. Use it for learning, ideas, and
                practice â€” not for cheating on tests or hiding your work from teachers or parents.
              </p>
            </div>
          </div>
        );
      };

      // ========= APP (CONVERSATIONS + THEME + ROUTING) =========
      const App = () => {
        const [currentView, setCurrentView] = useState('homework');
        const [grade, setGrade] = useState(8);
        const [conversations, setConversations] = useState([]);
        const [activeConversationId, setActiveConversationId] = useState(null);
        const [theme, setTheme] = useState(defaultTheme);
        const [isGeneratingTheme, setIsGeneratingTheme] = useState(false);

        // Load from localStorage
        useEffect(() => {
          try {
            const raw = localStorage.getItem(STORAGE_KEY_CONV);
            if (raw) {
              const parsed = JSON.parse(raw);
              setConversations(parsed);
              setActiveConversationId(parsed[0]?.id || null);
            } else {
              const first = createInitialConversation('homework', grade);
              setConversations([first]);
              setActiveConversationId(first.id);
            }
          } catch {
            const first = createInitialConversation('homework', grade);
            setConversations([first]);
            setActiveConversationId(first.id);
          }

          try {
            const themeRaw = localStorage.getItem(STORAGE_KEY_THEME);
            if (themeRaw) {
              setTheme(JSON.parse(themeRaw));
            }
          } catch {
            setTheme(defaultTheme);
          }
        }, []);

        const persistConversations = (list) => {
          setConversations(list);
          try {
            localStorage.setItem(STORAGE_KEY_CONV, JSON.stringify(list));
          } catch {}
        };

        const handleUpdateConversation = (updatedConv) => {
          persistConversations(
            conversations.map(c => (c.id === updatedConv.id ? updatedConv : c))
          );
        };

        const handleNewConversation = (mode) => {
          const conv = createInitialConversation(mode, grade);
          persistConversations([conv, ...conversations]);
          setActiveConversationId(conv.id);
          if (mode === 'homework' || mode === 'essay') setCurrentView(mode);
        };

        const handleSelectConversation = (id) => {
          const conv = conversations.find(c => c.id === id);
          if (!conv) return;
          setActiveConversationId(id);
          if (conv.mode === 'homework' || conv.mode === 'essay') {
            setCurrentView(conv.mode);
          }
        };

        const handleGenerateTheme = async (description) => {
          if (!description.trim()) return;
          setIsGeneratingTheme(true);
          try {
            const newTheme = await generateThemeFromDescription(description);
            setTheme(newTheme);
            localStorage.setItem(STORAGE_KEY_THEME, JSON.stringify(newTheme));
          } catch (e) {
            console.error("Theme generation error:", e);
          } finally {
            setIsGeneratingTheme(false);
          }
        };

        const homeworkConvs = conversations.filter(c => c.mode === 'homework');
        const essayConvs = conversations.filter(c => c.mode === 'essay');

        const getActiveConvForMode = (mode) => {
          const list = mode === 'essay' ? essayConvs : homeworkConvs;
          if (!list.length) {
            const conv = createInitialConversation(mode, grade);
            persistConversations([conv, ...conversations]);
            setActiveConversationId(conv.id);
            return conv;
          }
          const active = list.find(c => c.id === activeConversationId);
          return active || list[0];
        };

        const homeworkConv = getActiveConvForMode('homework');
        const essayConv = getActiveConvForMode('essay');

        return (
          <div
            className="flex h-screen bg-gray-950 text-gray-100 font-sans"
            style={{
              backgroundImage: `
                radial-gradient(circle at top, ${theme.glow}33 0, transparent 55%),
                radial-gradient(circle at bottom, ${theme.accent}22 0, transparent 60%)
              `
            }}
          >
            <Sidebar
              currentView={currentView}
              onViewChange={setCurrentView}
              grade={grade}
              onGradeChange={setGrade}
              conversations={conversations}
              activeConversationId={activeConversationId}
              onSelectConversation={handleSelectConversation}
              onNewConversation={handleNewConversation}
            />

            <main className="flex-1 overflow-hidden">
              {currentView === 'homework' && (
                <HomeworkChat
                  grade={grade}
                  conversation={homeworkConv}
                  onUpdateConversation={handleUpdateConversation}
                />
              )}
              {currentView === 'essay' && (
                <EssayMimic
                  grade={grade}
                  conversation={essayConv}
                  onUpdateConversation={handleUpdateConversation}
                />
              )}
              {currentView === 'quiz' && <QuizMode grade={grade} />}
              {currentView === 'settings' && (
                <SettingsView
                  theme={theme}
                  onGenerateTheme={handleGenerateTheme}
                  isGeneratingTheme={isGeneratingTheme}
                />
              )}
            </main>
          </div>
        );
      };

      const createInitialConversation = (mode, grade) => {
        const id = uuidv4();
        let firstMessage;
        if (mode === 'essay') {
          firstMessage = {
            id: uuidv4(),
            role: 'model',
            content:
              "Hi! I'm the Writing Helper. âœï¸\n\nPaste some of your writing so I can learn your style, or ask me how to start an essay.",
            timestamp: Date.now()
          };
        } else {
          firstMessage = {
            id: uuidv4(),
            role: 'model',
            content: `Hi! I'm YAI. ðŸ‘‹\n\nI'm set to **Grade ${grade}** level. You can talk to me about homework, hobbies, questions about life, or anything safe you're curious about.`,
            timestamp: Date.now()
          };
        }

        return {
          id,
          mode,
          title: mode === 'essay' ? 'Writing Chat' : 'Chat',
          messages: [firstMessage],
          styleProfile: '',
          lastMessage: '',
          updatedAt: Date.now()
        };
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
