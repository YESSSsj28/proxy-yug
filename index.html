<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YAI Study Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              gray: {
                750: '#2d3748',
                850: '#1a202c',
                950: '#0d1117',
              },
              brand: {
                50: '#f5f3ff',
                100: '#ede9fe',
                200: '#ddd6fe',
                300: '#c4b5fd',
                400: '#a78bfa',
                500: '#8b5cf6', // Violet
                600: '#7c3aed',
                700: '#6d28d9',
                800: '#5b21b6',
                900: '#4c1d95',
                950: '#2e1065',
              }
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'bounce-slight': 'bounce 1s infinite',
              'fadeIn': 'fadeIn 0.3s ease-out forwards',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          },
        },
      }
    </script>
    <style>
      /* Custom scrollbar for Webkit */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #111827; 
      }
      ::-webkit-scrollbar-thumb {
        background: #374151; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #4b5563; 
      }
      body {
        background-color: #020617; /* Very dark slate/blue */
        color: #f3f4f6;
      }
      .markdown-body p { margin-bottom: 0.75em; }
      .markdown-body ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 0.75em; }
      .markdown-body ol { list-style-type: decimal; margin-left: 1.5em; margin-bottom: 0.75em; }
      .markdown-body pre { background: #1e1b4b; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 0.75em; border: 1px solid #4338ca; }
      .markdown-body code { font-family: monospace; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(139, 92, 246, 0.5); }
    </style>
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0",
    "react-markdown": "https://esm.sh/react-markdown@9.0.1?deps=react@18.2.0",
    "uuid": "https://esm.sh/uuid@9.0.1",
    "@google/genai": "https://esm.sh/@google/genai",
    "react-dom/": "https://esm.sh/react-dom@^19.2.1/",
    "react/": "https://esm.sh/react@^19.2.1/"
  }
}
</script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Bot, User, AlertCircle, Send, Loader2, Baby, ListOrdered, 
        Image as ImageIcon, GraduationCap, BookOpen, PenTool, 
        Sparkles, AlertTriangle, Check, RefreshCw, Trash2, Paperclip, X,
        Menu, LogOut, MessageSquare, Plus, Settings, ChevronDown, UserCircle,
        BrainCircuit, Play, HelpCircle, ArrowRight, RotateCcw
      } from 'lucide-react';
      import ReactMarkdown from 'react-markdown';
      import { v4 as uuidv4 } from 'uuid';
      import { GoogleGenAI } from '@google/genai';

      // --- CONFIGURATION ---
      // Primary and Backup API Keys
      const API_KEYS = [
        "AIzaSyBx3AsRaRaKNQzmAQjecPjPVFoDFC3XAeE", // Primary
        "AIzaSyD12-IaCr9ZUy3154etS5q72SVqrDsf49Y"  // Backup
      ];
      
      let currentKeyIndex = 0;
      let ai = new GoogleGenAI({ apiKey: API_KEYS[0] });

      // --- KEY ROTATION LOGIC ---
      const rotateApiKey = () => {
        currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
        console.warn(`âš ï¸ API Quota Exceeded (429). Switching to API Key #${currentKeyIndex + 1}...`);
        ai = new GoogleGenAI({ apiKey: API_KEYS[currentKeyIndex] });
      };

      const isRateLimitError = (error) => {
        const msg = error?.message || '';
        const status = error?.status;
        return msg.includes('429') || status === 429 || msg.includes('Quota exceeded') || msg.includes('RESOURCE_EXHAUSTED');
      };

      // --- TYPES & CONSTANTS ---
      const Role = {
        USER: 'user',
        MODEL: 'model'
      };

      const STORAGE_KEYS = {
        CHATS: 'yai_chats_v2',
        SETTINGS: 'yai_settings_v2'
      };

      // --- HELPER TO RESTORE HISTORY FOR ROTATION ---
      const getHistoryFromMessages = (messages) => {
        return messages
          .filter(m => !m.isError && !m.isStreaming && m.role !== 'system') // Filter invalid
          .map(m => {
            const parts = [{ text: m.content }];
            // If we had image support stored in history, we'd add it here.
            // For now, we mainly restore text context to keep the conversation going.
            if (m.image) {
                // If the image data is available in the message object
                const base64 = m.image.split(',')[1];
                if (base64) {
                    parts.push({ inlineData: { mimeType: 'image/jpeg', data: base64 } });
                }
            }
            return {
              role: m.role,
              parts: parts
            };
          });
      };

      // --- GEMINI SERVICE ---
      
      const getSystemInstruction = (grade, style, mode = 'homework') => {
        if (mode === 'essay') {
          return ""; 
        }

        let base = `You are "YAI", a personalized AI Study Helper designed to help students in Grade ${grade}. 
        If asked "Who made you?", respond EXACTLY with: "**I was made by YAI's team.**"
        When asked "what model are you", say "I am YAI, your personal study assistant." Do NOT say you are Gemini or Google.
        
        Your goal is to adapt your explanation style strictly based on the user's request. 
        Always maintain a supportive, encouraging, and educational tone suitable for a Grade ${grade} student.
        Use Markdown for formatting.`;

        if (style === 'simple') {
          base += `\n\nSTYLE: SIMPLE. Explain concepts using language appropriate for Grade ${grade}. Avoid unnecessary jargon. Use analogies.`;
        } else if (style === 'steps') {
          base += `\n\nSTYLE: STEP-BY-STEP. Break everything down into numbered logical steps. Be a patient tutor.`;
        } else if (style === 'visual') {
          base += `\n\nSTYLE: VISUAL. Use vivid descriptions, ASCII diagrams, and spatial analogies to help the student visualize the concept.`;
        }

        return base;
      };

      const createHomeworkSession = (grade, style, history = []) => {
        return ai.chats.create({
          model: 'gemini-2.5-flash',
          config: {
            systemInstruction: getSystemInstruction(grade, style, 'homework'),
            temperature: 0.7,
            topK: 40,
          },
          history: history
        });
      };

      const analyzeWritingStyle = async (samples) => {
        const prompt = `
          Analyze the following writing samples to create a 'Human Writing Profile' designed SPECIFICALLY to bypass AI detection.
          
          Detectors flag:
          1. **Artificial Simplicity**: Simple Subject-Verb-Object sentences.
          2. **Speculative Focus**: Words like "implies", "suggests".
          3. **Predictable Rhythm**: Monotone sentence lengths.

          Analyze the user's text for:
          1. **Sentence Variety**: Run-ons? Fragments?
          2. **Messiness**: Backtracking? ("well, actually...").
          3. **Vocabulary**: Slang? Vague words?

          SAMPLES:
          "${samples}"

          OUTPUT FORMAT:
          Return a strict System Instruction for an LLM. 
          Start with: "You are YAI acting as a writing proxy. To ensure the text is undetectable as AI, you must adhere to these strict rules:"
          
          Explicitly list:
          - **BREAK THE RHYTHM**: Mix long, complex sentences with fragments.
          - **BAN "SPECULATIVE FOCUS"**: Ban "This implies", "In conclusion". 
          - **BAN "ARTIFICIAL SIMPLICITY"**: Ban starting sentences with "It is".
          - **FORCED ERRORS**: If the user has errors, replicate them.
        `;

        try {
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: prompt,
            });
            return response.text;
        } catch (error) {
            if (isRateLimitError(error)) {
                rotateApiKey();
                // Retry once
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                });
                return response.text;
            }
            throw error;
        }
      };

      const createCustomSession = (styleProfile, grade, history = []) => {
        const instruction = `${styleProfile}
        
        You are YAI.
        Target Grade Level: ${grade}.

        CRITICAL RULES FOR HUMANIZATION:
        1. **NO "SPECULATIVE FOCUS"**: BANNED: "This implies that...", "This suggests...".
        2. **DESTROY "ARTIFICIAL SIMPLICITY"**: NO Subject-Verb-Object repetition. Do not start sentences with "It is".
        3. **BREAK "PREDICTABLE RHYTHM"**: Varied sentence lengths. Use run-on sentences mixed with fragments.
        4. **ADD "HUMAN MESSINESS"**: Asides, fillers ("actually", "basically", "like").
        5. **LOWERCASE**: If the style implies it, use lowercase for emphasis.
        6. **VOCABULARY**: Use simple, utilitarian vocabulary. Avoid "delve", "tapestry", "moreover".
        7. **IDENTITY**: If asked "Who made you?", say "**I was made by YAI's team.**"
        
        If the user asks for an essay, write it EXACTLY as this specific human would.
        `;

        return ai.chats.create({
          model: 'gemini-2.5-flash',
          config: {
            systemInstruction: instruction,
            temperature: 1.3,
            topK: 80,
            topP: 0.98,
          },
          history: history
        });
      };

      const generateQuizData = async (topic, grade, weakAreas = null) => {
        const prompt = `
          You are a Quiz Generator for a Grade ${grade} student.
          
          TOPIC/CONTEXT:
          "${topic}"

          ${weakAreas ? `FOCUS ON THESE WEAK AREAS: ${weakAreas}` : ''}

          INSTRUCTIONS:
          1. Parse the topic. If it's raw notes (e.g., "grass green, rocks erode"), reword them into high-quality multiple choice questions.
          2. If it's a general topic (e.g., "Lawyer"), generate 5 relevant aptitude or knowledge questions.
          3. Generate EXACTLY 5 questions.
          4. For each question, provide 4 options (1 correct, 3 distractors).
          5. Provide a short "explanation" for why the correct answer is right.

          OUTPUT FORMAT:
          Return ONLY a raw JSON array. Do not use Markdown code blocks.
          [
            {
              "question": "string",
              "options": ["string", "string", "string", "string"],
              "correctAnswerIndex": number (0-3),
              "explanation": "string"
            }
          ]
        `;

        const execute = async () => {
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: prompt,
            });
            let text = response.text.trim();
            if (text.startsWith('```json')) text = text.replace(/^```json/, '').replace(/```$/, '');
            if (text.startsWith('```')) text = text.replace(/^```/, '').replace(/```$/, '');
            return JSON.parse(text);
        };

        try {
            return await execute();
        } catch (error) {
            if (isRateLimitError(error)) {
                rotateApiKey();
                return await execute();
            }
            throw error;
        }
      };

      const sendMessageStream = async (chat, messageText, imageData = null) => {
        try {
          let messagePayload;
          
          if (imageData) {
            const base64Data = imageData.includes('base64,') 
              ? imageData.split('base64,')[1] 
              : imageData;
            
            messagePayload = {
              parts: [
                { text: messageText },
                { inlineData: { mimeType: 'image/jpeg', data: base64Data } } 
              ]
            };
            return await chat.sendMessageStream({ message: messagePayload.parts });
          } else {
            return await chat.sendMessageStream({ message: messageText });
          }
        } catch (error) {
          console.error("Error sending message:", error);
          throw error;
        }
      };

      // --- COMPONENTS ---

      // MessageBubble
      const MessageBubble = ({ message }) => {
        const isUser = message.role === Role.USER;
        const isError = message.isError;

        return (
          <div className={`flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'}`}>
            <div className={`flex max-w-[85%] md:max-w-[75%] gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>
              
              <div className={`flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center overflow-hidden ${
                isUser ? 'bg-brand-600' : isError ? 'bg-red-500' : 'bg-gray-700'
              }`}>
                {isUser ? (
                   message.userAvatar ? <img src={message.userAvatar} alt="Me" className="w-full h-full object-cover"/> : <User size={16} className="text-white" />
                ) : isError ? (
                  <AlertCircle size={16} className="text-white" />
                ) : (
                  <Bot size={16} className="text-brand-300" />
                )}
              </div>

              <div className={`flex flex-col ${isUser ? 'items-end' : 'items-start'}`}>
                {message.image && (
                  <div className={`mb-2 rounded-lg overflow-hidden border border-gray-700 ${isUser ? 'rounded-tr-sm' : 'rounded-tl-sm'}`}>
                    <img src={message.image} alt="User upload" className="max-w-full h-auto max-h-64 object-cover" />
                  </div>
                )}

                <div
                  className={`px-4 py-3 rounded-2xl shadow-sm text-sm md:text-base leading-relaxed overflow-hidden ${
                    isUser
                      ? 'bg-brand-600 text-white rounded-tr-sm'
                      : isError
                      ? 'bg-red-900/50 border border-red-800 text-red-200 rounded-tl-sm'
                      : 'bg-gray-800 text-gray-100 border border-gray-700 rounded-tl-sm'
                  }`}
                >
                  {isError ? (
                     <span>{message.content}</span>
                  ) : (
                    <div className="markdown-body">
                      <ReactMarkdown
                        components={{
                          code({ node, className, children, ...props }) {
                            const match = /language-(\w+)/.exec(className || '');
                            const isInline = !match && !String(children).includes('\n');
                            if (isInline) {
                               return <code className="bg-black/20 px-1 py-0.5 rounded font-mono text-xs" {...props}>{children}</code>;
                            }
                            return (
                              <div className="relative my-2 overflow-hidden rounded-md bg-gray-950 border border-brand-900/50">
                                 <div className="flex items-center justify-between px-3 py-1 bg-gray-900 border-b border-gray-800">
                                    <span className="text-xs text-gray-400 font-mono lowercase">{match ? match[1] : 'code'}</span>
                                 </div>
                                 <pre className="p-3 overflow-x-auto text-sm font-mono text-gray-300">
                                  <code className={className} {...props}>{children}</code>
                                </pre>
                              </div>
                            );
                          },
                        }}
                      >
                        {message.content}
                      </ReactMarkdown>
                    </div>
                  )}
                  {message.isStreaming && <span className="inline-block w-2 h-4 ml-1 align-middle bg-brand-400 animate-pulse" />}
                </div>
                <span className="text-xs text-gray-500 mt-1 px-1">
                  {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </span>
              </div>
            </div>
          </div>
        );
      };

      // ChatInput
      const ChatInput = ({ onSend, disabled, showStyles = true, placeholder, selectedStyle, onStyleChange }) => {
        const [text, setText] = useState('');
        const [selectedImage, setSelectedImage] = useState(null);
        const textareaRef = useRef(null);
        const fileInputRef = useRef(null);

        const adjustHeight = () => {
          const textarea = textareaRef.current;
          if (textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${Math.min(textarea.scrollHeight, 150)}px`;
          }
        };

        useEffect(() => { adjustHeight(); }, [text]);

        const handleSubmit = () => {
          if ((text.trim() || selectedImage) && !disabled) {
            onSend(text.trim(), selectedImage);
            setText('');
            setSelectedImage(null);
            if (textareaRef.current) textareaRef.current.style.height = 'auto';
            if (fileInputRef.current) fileInputRef.current.value = '';
          }
        };

        const handleKeyDown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
          }
        };

        const handleFileChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => setSelectedImage(reader.result);
            reader.readAsDataURL(file);
          }
        };

        const styles = [
          { id: 'simple', label: 'Simple', icon: <Baby size={16} />, desc: 'Easy to understand' },
          { id: 'steps', label: 'Steps', icon: <ListOrdered size={16} />, desc: 'Step-by-Step' },
          { id: 'visual', label: 'Visual', icon: <ImageIcon size={16} />, desc: 'Imagery & Diagrams' },
        ];

        return (
          <div className="w-full bg-[#0d1117] border-t border-gray-800 p-4 pb-6 md:pb-8">
            <div className="max-w-4xl mx-auto space-y-3">
              {showStyles && (
                <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                  {styles.map((style) => (
                    <button
                      key={style.id}
                      onClick={() => onStyleChange(style.id)}
                      disabled={disabled}
                      className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all border ${
                        selectedStyle === style.id
                          ? 'bg-brand-600 border-brand-500 text-white shadow-md shadow-brand-900/20'
                          : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-750 hover:border-gray-600'
                      }`}
                    >
                      {style.icon}
                      <div className="flex flex-col items-start">
                        <span className="leading-none">{style.label}</span>
                        <span className="text-[10px] opacity-70 font-normal leading-none mt-0.5">{style.desc}</span>
                      </div>
                    </button>
                  ))}
                </div>
              )}

              {selectedImage && (
                <div className="relative inline-block mb-2">
                  <img src={selectedImage} alt="Preview" className="h-20 w-20 object-cover rounded-lg border border-gray-600" />
                  <button 
                    onClick={() => { setSelectedImage(null); if(fileInputRef.current) fileInputRef.current.value = ''; }}
                    className="absolute -top-2 -right-2 bg-gray-700 text-white rounded-full p-1 hover:bg-red-500 transition-colors shadow-sm"
                  >
                    <X size={12} />
                  </button>
                </div>
              )}

              <div className="relative flex items-end gap-2 bg-gray-800 p-2 rounded-2xl border border-gray-700 shadow-lg focus-within:ring-2 focus-within:ring-brand-500/50 focus-within:border-brand-500 transition-all">
                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                <button onClick={() => fileInputRef.current?.click()} disabled={disabled} className={`p-3 rounded-xl transition-colors ${selectedImage ? 'text-brand-400 bg-brand-900/20' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'}`}>
                  <Paperclip size={20} />
                </button>

                <textarea
                  ref={textareaRef}
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder={placeholder || "Ask YAI..."}
                  disabled={disabled}
                  rows={1}
                  className="w-full bg-transparent text-gray-100 placeholder-gray-500 text-base p-3 resize-none focus:outline-none max-h-[150px] overflow-y-auto custom-scrollbar disabled:opacity-50"
                  style={{ minHeight: '48px' }}
                />
                <button
                  onClick={handleSubmit}
                  disabled={(!text.trim() && !selectedImage) || disabled}
                  className={`p-3 rounded-xl flex-shrink-0 transition-all duration-200 ${
                    (text.trim() || selectedImage) && !disabled
                      ? 'bg-brand-600 text-white hover:bg-brand-500 shadow-lg hover:scale-105 active:scale-95'
                      : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  {disabled ? <Loader2 className="animate-spin" size={20} /> : <Send size={20} />}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Quiz Mode Component
      const QuizMode = ({ grade }) => {
        const [step, setStep] = useState('input'); // input, loading, quiz, results
        const [inputTopic, setInputTopic] = useState('');
        const [quizData, setQuizData] = useState([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [score, setScore] = useState(0);
        const [showExplanation, setShowExplanation] = useState(false);
        const [selectedAnswer, setSelectedAnswer] = useState(null); // index
        const [history, setHistory] = useState([]); // Track wrong answers for retry

        const handleGenerate = async (topic, weakAreas = null) => {
          setStep('loading');
          try {
            const data = await generateQuizData(topic, grade, weakAreas);
            setQuizData(data);
            setCurrentIndex(0);
            setScore(0);
            setHistory([]);
            setStep('quiz');
          } catch (e) {
            console.error(e);
            alert("Failed to generate quiz (Quota may be exceeded). Try again in a moment.");
            setStep('input');
          }
        };

        const handleAnswer = (index) => {
          if (selectedAnswer !== null) return;
          setSelectedAnswer(index);
          const currentQ = quizData[currentIndex];
          const isCorrect = index === currentQ.correctAnswerIndex;
          
          if (isCorrect) setScore(s => s + 1);
          
          setHistory(prev => [...prev, { ...currentQ, userCorrect: isCorrect }]);
        };

        const nextQuestion = () => {
          setSelectedAnswer(null);
          setShowExplanation(false);
          if (currentIndex < quizData.length - 1) {
            setCurrentIndex(c => c + 1);
          } else {
            setStep('results');
          }
        };

        if (step === 'input') {
          return (
            <div className="max-w-2xl mx-auto p-6 flex flex-col items-center justify-center h-full">
              <div className="bg-gradient-to-br from-brand-600 to-blue-600 p-4 rounded-2xl mb-6 shadow-lg shadow-brand-900/50">
                 <BrainCircuit className="text-white w-12 h-12" />
              </div>
              <h2 className="text-3xl font-bold text-white mb-2">Quiz Mode</h2>
              <p className="text-gray-400 text-center mb-8">
                Paste your notes, ask for a topic (e.g., "Civil War"), or enter rough questions. 
                YAI will auto-generate a structured quiz.
              </p>
              
              <textarea
                value={inputTopic}
                onChange={(e) => setInputTopic(e.target.value)}
                placeholder="e.g. 'Make me a quiz on photosynthesis' or paste your biology notes..."
                className="w-full h-40 bg-gray-900 border border-gray-800 rounded-xl p-4 text-gray-200 focus:ring-2 focus:ring-brand-500 outline-none resize-none mb-6"
              />
              
              <button
                onClick={() => handleGenerate(inputTopic)}
                disabled={!inputTopic.trim()}
                className="w-full bg-brand-600 hover:bg-brand-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg"
              >
                <Play size={20} fill="currentColor" /> Generate Quiz
              </button>
            </div>
          );
        }

        if (step === 'loading') {
          return (
            <div className="flex flex-col items-center justify-center h-full">
               <div className="relative">
                 <div className="w-24 h-24 bg-brand-500/20 rounded-full animate-ping absolute"></div>
                 <BrainCircuit className="text-brand-400 w-24 h-24 animate-pulse relative z-10" />
               </div>
               <h3 className="text-xl font-bold text-white mt-8 mb-2">Building Your Quiz...</h3>
               <p className="text-brand-300 text-sm animate-bounce-slight">Rewording questions & generating distractors</p>
            </div>
          );
        }

        if (step === 'quiz') {
          const q = quizData[currentIndex];
          const isAnswered = selectedAnswer !== null;
          const isCorrect = selectedAnswer === q.correctAnswerIndex;

          return (
            <div className="max-w-2xl mx-auto p-6 h-full flex flex-col">
               <div className="flex justify-between items-center mb-6 text-sm text-gray-400">
                  <span>Question {currentIndex + 1} of {quizData.length}</span>
                  <span className="bg-gray-800 px-3 py-1 rounded-full text-brand-300 font-mono">Score: {score}</span>
               </div>

               <div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 md:p-8 shadow-xl flex-1 flex flex-col">
                  <h3 className="text-xl md:text-2xl font-bold text-white mb-8 leading-relaxed">{q.question}</h3>
                  
                  <div className="grid grid-cols-1 gap-4 mb-auto">
                     {q.options.map((opt, idx) => {
                        let btnClass = "p-4 rounded-xl text-left border transition-all text-sm md:text-base font-medium ";
                        if (!isAnswered) {
                           btnClass += "bg-gray-800 border-gray-700 hover:bg-gray-750 text-gray-200";
                        } else {
                           if (idx === q.correctAnswerIndex) {
                              btnClass += "bg-green-900/40 border-green-500 text-green-100"; // Correct
                           } else if (idx === selectedAnswer) {
                              btnClass += "bg-red-900/40 border-red-500 text-red-100"; // Wrong selected
                           } else {
                              btnClass += "bg-gray-800/50 border-gray-800 text-gray-500 opacity-50"; // Others
                           }
                        }

                        return (
                          <button 
                            key={idx} 
                            onClick={() => handleAnswer(idx)}
                            disabled={isAnswered}
                            className={btnClass}
                          >
                             <div className="flex items-center gap-3">
                                <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs border ${
                                   isAnswered && idx === q.correctAnswerIndex ? 'border-green-400 text-green-400' : 'border-gray-600 text-gray-500'
                                }`}>
                                   {String.fromCharCode(65 + idx)}
                                </span>
                                {opt}
                             </div>
                          </button>
                        )
                     })}
                  </div>

                  {isAnswered && (
                     <div className="mt-6 pt-6 border-t border-gray-800 animate-[fadeIn_0.3s_ease-out]">
                        <div className="flex items-center justify-between mb-4">
                           <span className={`font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'}`}>
                              {isCorrect ? "Correct! ðŸŽ‰" : "Incorrect"}
                           </span>
                           {!showExplanation && (
                              <button onClick={() => setShowExplanation(true)} className="text-xs text-brand-400 hover:text-brand-300 flex items-center gap-1">
                                 <HelpCircle size={14}/> Why?
                              </button>
                           )}
                        </div>
                        
                        {showExplanation && (
                           <div className="bg-gray-950/50 p-4 rounded-lg mb-4 text-sm text-gray-300 border border-gray-800">
                              <span className="text-brand-400 font-bold block mb-1">Explanation:</span>
                              {q.explanation}
                           </div>
                        )}

                        <button onClick={nextQuestion} className="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                           {currentIndex < quizData.length - 1 ? "Next Question" : "See Results"} <ArrowRight size={18}/>
                        </button>
                     </div>
                  )}
               </div>
            </div>
          );
        }

        if (step === 'results') {
           const percentage = Math.round((score / quizData.length) * 100);
           const weakAreas = history.filter(h => !h.userCorrect).map(h => h.question).join("; ");

           return (
              <div className="max-w-md mx-auto p-6 flex flex-col items-center justify-center h-full text-center">
                 <div className="w-32 h-32 rounded-full border-4 border-gray-800 flex items-center justify-center mb-6 relative">
                    <div className="text-4xl font-bold text-white">{percentage}%</div>
                    <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                       <path className="text-gray-800" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="2" />
                       <path className="text-brand-500" strokeDasharray={`${percentage}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="2" />
                    </svg>
                 </div>
                 
                 <h2 className="text-2xl font-bold text-white mb-2">Quiz Complete!</h2>
                 <p className="text-gray-400 mb-8">You got {score} out of {quizData.length} correct.</p>

                 <div className="w-full space-y-3">
                    {percentage < 100 && (
                        <button 
                           onClick={() => handleGenerate(inputTopic, weakAreas)}
                           className="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2"
                        >
                           <RotateCcw size={18}/> Practice Weaknesses
                        </button>
                    )}
                    <button 
                       onClick={() => { setStep('input'); setInputTopic(''); }}
                       className="w-full bg-gray-800 hover:bg-gray-700 text-white font-medium py-3 rounded-xl border border-gray-700"
                    >
                       New Topic
                    </button>
                 </div>
              </div>
           );
        }
      };

      // Sidebar
      const Sidebar = ({ isOpen, onClose, chats, activeChatId, onSelectChat, onNewChat, activeView }) => {
        // Filter chats based on view (Essay vs Homework) - Quiz doesn't have history in this version
        const visibleChats = chats.filter(c => c.mode === activeView);

        return (
          <>
            {isOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={onClose} />}
            <div className={`fixed inset-y-0 left-0 w-64 bg-[#0d1117] border-r border-gray-800 transform transition-transform duration-300 z-40 flex flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
              <div className="p-4 border-b border-gray-800 flex items-center gap-3">
                 <div className="bg-gradient-to-br from-brand-600 to-blue-600 p-1.5 rounded-lg">
                    <GraduationCap className="text-white h-5 w-5" />
                 </div>
                 <h1 className="font-bold text-white tracking-wide">YAI</h1>
                 <button onClick={onClose} className="ml-auto md:hidden text-gray-400"><X size={20}/></button>
              </div>

              <div className="p-4">
                <button onClick={onNewChat} className="w-full bg-brand-600 hover:bg-brand-500 text-white py-2.5 px-4 rounded-xl flex items-center justify-center gap-2 font-medium transition-all shadow-lg shadow-brand-900/20">
                  <Plus size={18} /> New Chat
                </button>
              </div>

              <div className="flex-1 overflow-y-auto custom-scrollbar px-3 py-2 space-y-1">
                <p className="text-xs font-semibold text-gray-500 px-3 mb-2 uppercase tracking-wider">{activeView} Chats</p>
                {visibleChats.length === 0 && (
                  <div className="text-center py-8 text-gray-600 text-sm">No chats yet</div>
                )}
                {visibleChats.map(chat => (
                  <button
                    key={chat.id}
                    onClick={() => onSelectChat(chat.id)}
                    className={`w-full text-left px-3 py-2.5 rounded-lg text-sm truncate flex items-center gap-2 transition-colors ${
                      activeChatId === chat.id 
                        ? 'bg-gray-800 text-white border border-gray-700' 
                        : 'text-gray-400 hover:bg-gray-800/50 hover:text-gray-200'
                    }`}
                  >
                    <MessageSquare size={14} className={activeChatId === chat.id ? "text-brand-400" : "text-gray-500"} />
                    <span className="truncate">{chat.title || "New Conversation"}</span>
                  </button>
                ))}
              </div>
            </div>
          </>
        );
      };

      // App Layout & Logic
      const App = () => {
        // User State (Simplified - Guest Mode Only)
        const [user] = useState({ name: "Student", avatar: null }); 
        
        const [viewMode, setViewMode] = useState('homework');
        const [grade, setGrade] = useState('8'); // Default 8th Grade
        const [isSidebarOpen, setIsSidebarOpen] = useState(false);
        
        // Chat Data
        const [chats, setChats] = useState([]);
        const [activeChatId, setActiveChatId] = useState(null);
        const [messages, setMessages] = useState([]);
        const [isProcessing, setIsProcessing] = useState(false);
        const [selectedStyle, setSelectedStyle] = useState('simple'); // for homework

        // Refs
        const chatSessionRef = useRef(null);
        const messagesEndRef = useRef(null);

        // Load Initial Data
        useEffect(() => {
          const storedChats = localStorage.getItem(STORAGE_KEYS.CHATS);
          if (storedChats) setChats(JSON.parse(storedChats));
        }, []);

        // Save chats when changed
        useEffect(() => {
          if (chats.length > 0) {
            localStorage.setItem(STORAGE_KEYS.CHATS, JSON.stringify(chats));
          }
        }, [chats]);

        // Scroll to bottom
        useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isProcessing]);

        const createNewChat = (mode = null) => {
          const targetMode = mode || viewMode;
          // If in Quiz mode, create new chat defaults to homework
          const finalMode = targetMode === 'quiz' ? 'homework' : targetMode;
          if (targetMode === 'quiz') setViewMode('homework');

          const newId = uuidv4();
          const welcomeMsg = finalMode === 'homework' 
            ? `Hi! I'm YAI. \n\nI'm set to **Grade ${grade}** level. How can I help you study today?`
            : "Let's work on your writing. Paste a sample of your text to get started.";
            
          const newChat = {
            id: newId,
            title: "New Conversation",
            messages: [{
              id: uuidv4(),
              role: Role.MODEL,
              content: welcomeMsg,
              timestamp: new Date().toISOString()
            }],
            mode: finalMode,
            timestamp: new Date().toISOString()
          };

          setChats(prev => [newChat, ...prev]);
          setActiveChatId(newId);
          setMessages(newChat.messages.map(m => ({...m, timestamp: new Date(m.timestamp)})));
          
          // Reset Gemini session
          if (finalMode === 'homework') {
             chatSessionRef.current = createHomeworkSession(grade, selectedStyle);
          } else {
             chatSessionRef.current = null; 
          }
          
          setIsSidebarOpen(false);
        };

        const handleSelectChat = (chatId) => {
          const chat = chats.find(c => c.id === chatId);
          if (chat) {
            setActiveChatId(chatId);
            setMessages(chat.messages.map(m => ({...m, timestamp: new Date(m.timestamp)})));
            setViewMode(chat.mode);
            // Re-create session from history when loading chat
            if (chat.mode === 'homework') {
              const history = getHistoryFromMessages(chat.messages);
              chatSessionRef.current = createHomeworkSession(grade, selectedStyle, history);
            } else if (chat.mode === 'essay') {
                // For essay, we need the profile, which is hidden in session. 
                // Simplified: we just clear session for now and let user re-teach if needed 
                // OR we assume standard config. 
                // For this demo, let's just clear.
                chatSessionRef.current = null; 
            }
            setIsSidebarOpen(false);
          }
        };

        const updateActiveChatMessages = (newMessages) => {
          setMessages(newMessages);
          setChats(prev => prev.map(c => {
             if (c.id === activeChatId) {
               let title = c.title;
               const lastMsg = newMessages[newMessages.length - 1];
               if (c.title === "New Conversation" && lastMsg.role === Role.USER) {
                 title = lastMsg.content.slice(0, 30) + (lastMsg.content.length > 30 ? "..." : "");
               }
               return { 
                 ...c, 
                 messages: newMessages.map(m => ({...m, timestamp: m.timestamp.toISOString()})), 
                 title 
               };
             }
             return c;
          }));
        };

        const handleSendMessage = useCallback(async (text, image) => {
          if (!activeChatId) createNewChat();

          if (!chatSessionRef.current && viewMode === 'homework') {
             chatSessionRef.current = createHomeworkSession(grade, selectedStyle);
          }
          
          const userMsg = { 
             id: uuidv4(), 
             role: Role.USER, 
             content: text, 
             timestamp: new Date(), 
             image,
             userAvatar: user?.avatar
          };
          
          const newMessages = [...messages, userMsg];
          updateActiveChatMessages(newMessages);
          setIsProcessing(true);

          try {
            let prompt = text;
            if (viewMode === 'homework') {
               prompt = `${getSystemInstruction(grade, selectedStyle, 'homework')}\n\nUSER: ${text}`;
            }

            const executeStream = async () => {
                return await sendMessageStream(chatSessionRef.current, prompt, image);
            }

            let stream;
            try {
                stream = await executeStream();
            } catch(e) {
                if (isRateLimitError(e)) {
                    rotateApiKey();
                    // Recover session
                    const history = getHistoryFromMessages(messages); // Use history up to last success
                    
                    if (viewMode === 'homework') {
                        chatSessionRef.current = createHomeworkSession(grade, selectedStyle, history);
                    } else if (viewMode === 'essay') {
                        chatSessionRef.current = createCustomSession("", grade, history);
                    }
                    
                    stream = await executeStream(); // Retry with new key/session
                } else {
                    throw e;
                }
            }

            const modelMsgId = uuidv4();
            const initialModelMsg = { id: modelMsgId, role: Role.MODEL, content: '', timestamp: new Date(), isStreaming: true };
            
            updateActiveChatMessages([...newMessages, initialModelMsg]);

            let fullContent = '';
            for await (const chunk of stream) {
               if (chunk.text) {
                 fullContent += chunk.text;
                 setMessages(current => current.map(m => m.id === modelMsgId ? {...m, content: fullContent} : m));
               }
            }
            
            setMessages(current => {
               const final = current.map(m => m.id === modelMsgId ? {...m, content: fullContent, isStreaming: false} : m);
               setChats(prev => prev.map(c => c.id === activeChatId ? {...c, messages: final.map(f => ({...f, timestamp: f.timestamp.toISOString()}))} : c));
               return final;
            });

          } catch (e) {
            console.error(e);
            setMessages(prev => [...prev, {
                id: uuidv4(),
                role: Role.MODEL,
                content: "I'm having trouble connecting right now. Please wait a moment and try again.",
                timestamp: new Date(),
                isError: true
            }]);
          } finally {
            setIsProcessing(false);
          }
        }, [messages, activeChatId, chats, grade, selectedStyle, viewMode, user]);

        // Essay Mode Handler
        const handleEssayAnalyze = async (samples) => {
            try {
                const result = await analyzeWritingStyle(samples);
                chatSessionRef.current = createCustomSession(result, grade);
                // Store profile in chat metadata if we were doing robust persistence
                
                const modelMsg = {
                id: uuidv4(),
                role: Role.MODEL,
                content: `**Style Learned.** I am now YAI, mimicking your writing style for Grade ${grade}. What shall we write?`,
                timestamp: new Date()
                };
                const updated = [...messages, modelMsg];
                updateActiveChatMessages(updated);
            } catch (e) {
                console.error(e);
                alert("Failed to analyze style. Please try again.");
            }
        };

        return (
          <div className="flex h-screen overflow-hidden">
            {viewMode !== 'quiz' && (
               <Sidebar 
               isOpen={isSidebarOpen} 
               onClose={() => setIsSidebarOpen(false)}
               chats={chats}
               activeChatId={activeChatId}
               onSelectChat={handleSelectChat}
               onNewChat={() => createNewChat(viewMode)}
               activeView={viewMode}
               />
            )}

            <div className={`flex-1 flex flex-col min-w-0 bg-[#020617] relative ${viewMode !== 'quiz' ? 'md:ml-64' : ''} transition-all duration-300`}>
               {/* Header */}
               <header className="h-16 border-b border-gray-800 flex items-center justify-between px-4 bg-gray-950/80 backdrop-blur-md sticky top-0 z-10">
                  <div className="flex items-center gap-3">
                     {viewMode !== 'quiz' && <button onClick={() => setIsSidebarOpen(true)} className="md:hidden text-gray-400"><Menu/></button>}
                     
                     {/* Simplified Logo for Mobile/Desktop */}
                     <div className="flex items-center gap-2">
                        <div className="bg-gradient-to-br from-brand-600 to-blue-600 p-1.5 rounded-lg hidden sm:block">
                           <GraduationCap className="text-white h-5 w-5" />
                        </div>
                        <h1 className="font-bold text-gray-100 hidden sm:block">YAI</h1>
                     </div>

                     <div className="flex bg-gray-900/50 p-1 rounded-xl border border-gray-800 ml-2">
                        <button onClick={() => { setViewMode('homework'); if(!activeChatId) createNewChat('homework'); }} className={`px-3 py-1.5 rounded-lg text-xs md:text-sm font-medium transition-all ${viewMode === 'homework' ? 'bg-gray-800 text-white' : 'text-gray-400'}`}>Homework</button>
                        <button onClick={() => { setViewMode('essay'); if(!activeChatId && viewMode !== 'essay') createNewChat('essay'); }} className={`px-3 py-1.5 rounded-lg text-xs md:text-sm font-medium transition-all ${viewMode === 'essay' ? 'bg-brand-900/30 text-brand-100' : 'text-gray-400'}`}>Essay</button>
                        <button onClick={() => setViewMode('quiz')} className={`px-3 py-1.5 rounded-lg text-xs md:text-sm font-medium transition-all flex items-center gap-1 ${viewMode === 'quiz' ? 'bg-blue-900/30 text-blue-100' : 'text-gray-400'}`}><BrainCircuit size={14}/> Quiz</button>
                     </div>
                  </div>
                  
                  <div className="flex items-center gap-2">
                     <span className="text-xs text-gray-500 hidden sm:inline">Grade:</span>
                     <div className="relative">
                        <select 
                           value={grade} 
                           onChange={(e) => { setGrade(e.target.value); chatSessionRef.current = null; }}
                           className="bg-gray-900 border border-gray-700 text-white text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full p-2 appearance-none pl-3 pr-8"
                        >
                           {[8,9,10,11,12].map(g => <option key={g} value={g}>{g}th Grade</option>)}
                        </select>
                        <ChevronDown className="absolute right-2 top-2.5 text-gray-500 pointer-events-none" size={14} />
                     </div>
                  </div>
               </header>

               {/* Content Area */}
               <main className="flex-1 overflow-hidden relative flex flex-col">
                  {viewMode === 'quiz' ? (
                     <QuizMode grade={grade} />
                  ) : (
                     <>
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 scroll-smooth">
                           <div className="max-w-4xl mx-auto flex flex-col justify-end min-h-full">
                              {!activeChatId && createNewChat(viewMode)}
                              
                              {messages.length === 0 && viewMode === 'essay' && (
                                 <EssaySetup onAnalyze={handleEssayAnalyze} />
                              )}
                              
                              {messages.map(msg => <MessageBubble key={msg.id} message={msg} />)}
                              
                              {isProcessing && <div className="flex w-full mb-6 justify-start"><div className="flex items-center gap-2 text-gray-500 text-sm italic"><span className="w-2 h-2 bg-brand-500 rounded-full animate-pulse"></span>YAI is thinking...</div></div>}
                              <div ref={messagesEndRef} className="h-4" />
                           </div>
                        </div>

                        {/* Input */}
                        {(viewMode === 'homework' || (viewMode === 'essay' && messages.length > 0)) && (
                           <ChatInput 
                              onSend={handleSendMessage} 
                              disabled={isProcessing} 
                              showStyles={viewMode === 'homework'}
                              selectedStyle={selectedStyle}
                              onStyleChange={setSelectedStyle}
                              placeholder={viewMode === 'essay' ? "Write essay..." : "Ask YAI..."}
                           />
                        )}
                     </>
                  )}
               </main>
            </div>
          </div>
        );
      };

      // Helper Component for Essay Setup
      const EssaySetup = ({ onAnalyze }) => {
          const [text, setText] = useState('');
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          return (
             <div className="bg-gray-900/50 border border-gray-800 rounded-2xl p-6 md:p-10 text-center max-w-2xl mx-auto my-auto">
                <div className="inline-flex items-center justify-center p-3 bg-brand-600 rounded-2xl mb-4 shadow-lg shadow-brand-900/40">
                   <PenTool className="text-white h-8 w-8" />
                </div>
                <h2 className="text-2xl font-bold text-white mb-2">Teach YAI Your Style</h2>
                <p className="text-gray-400 mb-6">Paste a few paragraphs of your writing. YAI will analyze your sentence structure and errors to write exactly like you.</p>
                <textarea 
                   value={text} onChange={e => setText(e.target.value)} 
                   className="w-full h-48 bg-gray-950 border border-gray-800 rounded-xl p-4 text-gray-200 focus:ring-2 focus:ring-brand-500/50 outline-none resize-none mb-4"
                   placeholder="Paste your old essays here..."
                />
                <button 
                   onClick={async () => { setIsAnalyzing(true); await onAnalyze(text); setIsAnalyzing(false); }}
                   disabled={text.length < 50 || isAnalyzing}
                   className="w-full bg-brand-600 hover:bg-brand-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 rounded-xl transition-all"
                >
                   {isAnalyzing ? "Analyzing..." : "Start Essay Mode"}
                </button>
             </div>
          );
      }

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
